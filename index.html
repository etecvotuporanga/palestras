<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrições - Semana Acadêmica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-md">
        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Inscrições - Semana Acadêmica</h1>
        <div id="auth-container" class="flex items-center space-x-4">
            <div id="user-info" class="hidden text-right">
                <p class="font-semibold text-gray-700" id="user-name"></p>
                <p class="text-sm text-gray-500" id="user-email"></p>
            </div>
            <button id="delete-my-registrations-button" class="hidden bg-red-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-700 transition duration-300 shadow-sm">
                Excluir Minhas Inscrições
            </button>
            <button id="auth-button" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow-sm">
                Login com Google
            </button>
        </div>
    </header>

    <main id="lectures-container" class="space-y-6">
        <div class="flex justify-center items-center h-40">
            <div class="loader"></div>
            <p class="ml-4 text-gray-600">Carregando palestras...</p>
        </div>
    </main>

    <footer class="text-center mt-12 text-gray-500">
        <p>&copy; 2024 Semana Acadêmica. Todos os direitos reservados.</p>
    </footer>
</div>

<script type="module">
// Importações do Firebase, adicionando doc e deleteDoc
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- CONFIGURAÇÃO FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyD0rC3RYKVEutV4lg1UMehtavZmATEE3gk",
    authDomain: "palestras-ac51e.firebaseapp.com",
    projectId:  "palestras-ac51e",
    storageBucket: "palestras-ac51e.appspot.com",
    messagingSenderId: "961901054844",
    appId: "1:961901054844:web:15118d30a8d2fbdac032f9"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const registrationsCollection = collection(db, `artifacts/default-lecture-app/public/data/registrations`);

const lectures = [
    { id: 'medicina', title: 'Avanços Recentes em Medicina' },
    { id: 'ciberseguranca', title: 'Segurança Cibernética no Mundo Moderno' },
    { id: 'robotica', title: 'Robótica Aplicada à Engenharia' },
    { id: 'ia', title: 'Inteligência Artificial e o Futuro do Trabalho' },
    { id: 'marketing', title: 'Marketing Digital Pós-Pandemia' },
    { id: 'financas', title: 'Finanças Pessoais e Investimentos para Jovens' }
];
const TOTAL_SPOTS = 40;

// --- ELEMENTOS DOM ---
const authButton = document.getElementById('auth-button');
const userInfoDiv = document.getElementById('user-info');
const userNameP = document.getElementById('user-name');
const userEmailP = document.getElementById('user-email');
const lecturesContainer = document.getElementById('lectures-container');
const deleteMyRegistrationsButton = document.getElementById('delete-my-registrations-button');

// --- AUTENTICAÇÃO ---
onAuthStateChanged(auth, user => updateUIForAuthState(user));

function updateUIForAuthState(user) {
    if (user) {
        userNameP.textContent = user.displayName || 'Usuário';
        userEmailP.textContent = user.email || '';
        userInfoDiv.classList.remove('hidden');
        deleteMyRegistrationsButton.classList.remove('hidden'); // Mostra o botão de excluir
        authButton.textContent = 'Sair';
        authButton.onclick = () => signOut(auth);
        document.querySelectorAll('.student-email-input').forEach(i => i.value = user.email || '');
        document.querySelectorAll('.student-name-input').forEach(i => i.value = user.displayName || '');
    } else {
        userInfoDiv.classList.add('hidden');
        deleteMyRegistrationsButton.classList.add('hidden'); // Esconde o botão de excluir
        authButton.textContent = 'Login com Google';
        authButton.onclick = () => signInWithPopup(auth, provider);
        document.querySelectorAll('.student-email-input').forEach(i => i.value = '');
        document.querySelectorAll('.student-name-input').forEach(i => i.value = '');
    }
}

// --- RENDERIZAÇÃO DAS PALESTRAS ---
function renderLectures() {
    lecturesContainer.innerHTML = '';
    lectures.forEach(lecture => {
        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-xl shadow-md';
        card.id = `card-${lecture.id}`;
        card.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">${lecture.title}</h2>
                    <p class="text-green-600 font-semibold mt-2">
                        Vagas Preenchidas: <span id="count-${lecture.id}">0</span> / ${TOTAL_SPOTS}
                    </p>
                </div>
                <div id="status-${lecture.id}" class="mt-4 md:mt-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
                    Aguardando...
                </div>
            </div>
            <div class="mt-4 border-t pt-4">
                <form id="form-${lecture.id}" data-lecture-id="${lecture.id}" class="space-y-4">
                    <p class="text-sm font-medium text-gray-600">Inscreva-se agora:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><input type="text" id="name-${lecture.id}" required placeholder="Seu nome completo" class="student-name-input w-full px-4 py-2 border rounded-lg"></div>
                        <div><input type="email" id="email-${lecture.id}" required placeholder="Seu melhor e-mail" class="student-email-input w-full px-4 py-2 border rounded-lg"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <select id="serie-${lecture.id}" required class="w-full px-4 py-2 border rounded-lg bg-white text-gray-700">
                                <option value="" disabled selected>Sua série</option>
                                <option value="1">1ª Série</option>
                                <option value="2">2ª Série</option>
                                <option value="3">3ª Série</option>
                            </select>
                        </div>
                        <div>
                            <select id="curso-${lecture.id}" required class="w-full px-4 py-2 border rounded-lg bg-white text-gray-700">
                                <option value="" disabled selected>Seu curso</option>
                                <option value="Administração de Empresas">Administração de Empresas</option>
                                <option value="Informática para Internet">Informática para Internet</option>
                                <option value="Desenvolvimento de Sistemas">Desenvolvimento de Sistemas</option>
                            </select>
                        </div>
                        <div>
                            <select id="periodo-${lecture.id}" required class="w-full px-4 py-2 border rounded-lg bg-white text-gray-700">
                                <option value="" disabled selected>Seu período</option>
                                <option value="Integral">Integral</option>
                                <option value="Noturno">Noturno</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="submit" class="w-full sm:w-auto bg-green-600 text-white font-semibold px-6 py-2 rounded-lg">Confirmar Inscrição</button>
                        <button type="button" class="view-registrations-btn w-full sm:w-auto bg-blue-500 text-white px-6 py-2 rounded-lg" data-lecture-id="${lecture.id}">Ver Inscritos</button>
                    </div>
                </form>
                <div id="message-${lecture.id}" class="mt-3 text-sm font-medium"></div>
                <div id="registrations-list-${lecture.id}" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border max-h-60 overflow-y-auto">
                    <h4 class="font-bold mb-2 text-gray-800">Inscritos:</h4>
                    <ul id="list-ul-${lecture.id}" class="list-disc list-inside text-gray-700 space-y-1"></ul>
                </div>
            </div>
        `;
        lecturesContainer.appendChild(card);
    });
    updateUIForAuthState(auth.currentUser);
}

// --- INSCRIÇÃO ---
async function handleRegistration(event) {
    event.preventDefault();
    const user = auth.currentUser;
    if (!user) { displayMessage(event.target.dataset.lectureId, 'Faça login com Google antes.', 'red'); return; }

    const lectureId = event.target.dataset.lectureId;
    const form = document.getElementById(`form-${lectureId}`);
    const name = document.getElementById(`name-${lectureId}`).value.trim();
    const email = document.getElementById(`email-${lectureId}`).value.trim().toLowerCase();
    const serie = document.getElementById(`serie-${lectureId}`).value;
    const curso = document.getElementById(`curso-${lectureId}`).value;
    const periodo = document.getElementById(`periodo-${lectureId}`).value;
    const button = form.querySelector('button[type="submit"]');

    if (!name || !email || !serie || !curso || !periodo) {
        displayMessage(lectureId, 'Preencha todos os campos para se inscrever.', 'red');
        return;
    }
    button.disabled = true; button.textContent = 'Processando...';
    try {
        // --- ALTERAÇÃO PRINCIPAL AQUI ---
        // A consulta agora verifica se o e-mail existe em QUALQUER palestra,
        // removendo a condição 'where("lectureId", "==", lectureId)'.
        const q = query(registrationsCollection, where("studentEmail", "==", email));
        const snapshot = await getDocs(q);

        // A mensagem de erro também foi atualizada para ser mais clara.
        if (!snapshot.empty) { displayMessage(lectureId, 'Você já está inscrito em uma palestra. Exclua sua inscrição anterior para se inscrever em outra.', 'orange'); throw "duplicado"; }

        await addDoc(registrationsCollection, {
            lectureId, studentName: name, studentEmail: email, serie, curso, periodo,
            registeredAt: serverTimestamp(), userId: user.uid
        });
        displayMessage(lectureId, 'Inscrição realizada com sucesso!', 'green');
        form.reset();
        updateUIForAuthState(auth.currentUser); // Atualiza os campos de nome e e-mail
    } catch (err) {
        if (err !== "duplicado") displayMessage(lectureId, 'Erro ao registrar. Tente novamente.', 'red');
    } finally { button.disabled = false; button.textContent = 'Confirmar Inscrição'; }
}

// --- NOVA FUNÇÃO: EXCLUIR TODAS AS INSCRIÇÕES DO USUÁRIO ---
async function handleDeleteMyRegistrations() {
    const user = auth.currentUser;
    if (!user || !user.email) {
        alert("Você precisa estar logado para excluir suas inscrições.");
        return;
    }

    if (!confirm("Tem certeza que deseja excluir TODAS as suas inscrições? Esta ação não pode ser desfeita.")) {
        return;
    }

    this.disabled = true;
    this.textContent = "Excluindo...";

    try {
        // 1. Encontrar todas as inscrições com o e-mail do usuário
        const q = query(registrationsCollection, where("studentEmail", "==", user.email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            alert("Nenhuma inscrição encontrada para o seu e-mail.");
            return;
        }

        // 2. Criar uma promessa de exclusão para cada documento encontrado
        const deletePromises = [];
        querySnapshot.forEach(docSnapshot => {
            deletePromises.push(deleteDoc(doc(db, `artifacts/default-lecture-app/public/data/registrations`, docSnapshot.id)));
        });

        // 3. Executar todas as exclusões
        await Promise.all(deletePromises);

        alert(`Sucesso! ${deletePromises.length} inscrição(ões) foram excluídas.`);

    } catch (error) {
        console.error("Erro ao excluir inscrições:", error);
        alert("Ocorreu um erro ao tentar excluir suas inscrições. Tente novamente.");
    } finally {
        this.disabled = false;
        this.textContent = "Excluir Minhas Inscrições";
    }
}


// --- MENSAGENS ---
function displayMessage(lectureId, text, color) {
    const el = document.getElementById(`message-${lectureId}`);
    const colors = { red: 'text-red-600', green: 'text-green-600', orange: 'text-orange-500' };
    el.textContent = text; el.className = `mt-3 text-sm font-medium ${colors[color]||'text-gray-600'}`;
    setTimeout(()=>{el.textContent='';}, 5000);
}

// --- LISTAGEM E CONTAGEM EM TEMPO REAL ---
function listenToRegistrations() {
    onSnapshot(registrationsCollection, snapshot => {
        const counts = {}; const registrations = {};
        lectures.forEach(l=>{ counts[l.id]=0; registrations[l.id]=[]; });

        snapshot.docs.forEach(doc=>{
            const data = doc.data();
            if (data.lectureId && counts.hasOwnProperty(data.lectureId)) {
                counts[data.lectureId]++;
                // MODIFICAÇÃO 1: Armazena um objeto com nome, série e curso
                registrations[data.lectureId].push({
                    name: data.studentName,
                    serie: data.serie,
                    curso: data.curso
                });
            }
        });

        lectures.forEach(l=>{
            document.getElementById(`count-${l.id}`).textContent = counts[l.id];
            const statusEl = document.getElementById(`status-${l.id}`);
            const form = document.getElementById(`form-${l.id}`);
            const button = form.querySelector('button[type="submit"]');

            if(counts[l.id] >= TOTAL_SPOTS){
                statusEl.textContent='Vagas Esgotadas'; statusEl.className='mt-4 md:mt-0 px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-700';
                form.querySelectorAll('input, button[type="submit"], select').forEach(i=>i.disabled=true); button.textContent='Esgotado';
            } else {
                statusEl.textContent='Vagas Disponíveis'; statusEl.className='mt-4 md:mt-0 px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-700';
                form.querySelectorAll('input, button[type="submit"], select').forEach(i=>i.disabled=false); button.textContent='Confirmar Inscrição';
            }

            const listUl = document.getElementById(`list-ul-${l.id}`);
            const registrants = registrations[l.id];
            // MODIFICAÇÃO 2: Gera a lista exibindo nome, série e curso
            listUl.innerHTML = registrants.length > 0
                ? registrants.map(r => `<li>${r.name} - ${r.serie}ª Série - ${r.curso}</li>`).join('')
                : '<li>Ainda não há inscritos.</li>';
        });
        updateUIForAuthState(auth.currentUser); // Garante que o estado dos formulários esteja correto após o login
    });
}

// --- TOGGLE LISTA ---
function toggleRegistrationsList(lectureId) {
    const listContainer = document.getElementById(`registrations-list-${lectureId}`);
    const button = document.querySelector(`.view-registrations-btn[data-lecture-id="${lectureId}"]`);
    const isHidden = listContainer.classList.toggle('hidden');
    button.textContent = isHidden ? 'Ver Inscritos' : 'Ocultar Inscritos';
}

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', () => {
    renderLectures();
    listenToRegistrations();
    lecturesContainer.addEventListener('submit', handleRegistration);
    lecturesContainer.addEventListener('click', e => { if(e.target.classList.contains('view-registrations-btn')) toggleRegistrationsList(e.target.dataset.lectureId); });
    // Adiciona o evento de clique para o novo botão
    deleteMyRegistrationsButton.addEventListener('click', handleDeleteMyRegistrations);
});
</script>
</body>
</html>